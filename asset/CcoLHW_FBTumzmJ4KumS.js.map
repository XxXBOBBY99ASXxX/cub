{"version":3,"file":"CcoLHW_FBTumzmJ4KumS.js","sources":["../../src/stores/GatewayConnectionStore.ts"],"sourcesContent":["import {\n\tAPIGuildMember,\n\tAPIMessage,\n\tChannelType,\n\tGatewayActivity,\n\tGatewayChannelCreateDispatchData,\n\tGatewayChannelDeleteDispatchData,\n\tGatewayChannelUpdateDispatchData,\n\tGatewayCloseCodes,\n\tGatewayDispatchEvents,\n\tGatewayDispatchPayload,\n\tGatewayGuild,\n\tGatewayGuildCreateDispatchData,\n\tGatewayGuildDeleteDispatchData,\n\tGatewayGuildMemberAddDispatchData,\n\tGatewayGuildMemberListUpdateDispatchData,\n\tGatewayGuildMemberRemoveDispatchData,\n\tGatewayGuildMemberUpdateDispatchData,\n\tGatewayGuildModifyDispatchData,\n\tGatewayHeartbeat,\n\tGatewayHelloData,\n\tGatewayIdentify,\n\tGatewayLazyRequest,\n\tGatewayLazyRequestData,\n\tGatewayMessageCreateDispatchData,\n\tGatewayMessageDeleteBulkDispatchData,\n\tGatewayMessageDeleteDispatchData,\n\tGatewayMessageUpdateDispatchData,\n\tGatewayOpcodes,\n\tGatewayPresenceUpdateDispatchData,\n\tGatewayReadyDispatchData,\n\tGatewayReceivePayload,\n\tGatewaySendPayload,\n\tGatewayTypingStartDispatchData,\n\tGatewayUserUpdateDispatchData,\n\tPresenceUpdateStatus,\n\tSnowflake,\n} from \"@spacebarchat/spacebar-api-types/v9\";\nimport { action, makeObservable, observable, runInAction } from \"mobx\";\nimport Logger from \"../utils/Logger\";\nimport { debounce } from \"../utils/debounce\";\nimport AppStore from \"./AppStore\";\n\nconst GATEWAY_VERSION = \"9\";\nconst GATEWAY_ENCODING = \"json\";\nconst RECONNECT_TIMEOUT = 10000; // start at 10 seconds, doubles each time\n\ninterface GatewaySession {\n\tactive: boolean;\n\tactivities: GatewayActivity[];\n\tclient_info: {\n\t\tclient?: string;\n\t\tos?: string;\n\t\tversion?: number;\n\t};\n\tsession_id: string;\n\tstatus: PresenceUpdateStatus;\n}\n\nexport default class GatewayConnectionStore {\n\tprivate readonly logger: Logger = new Logger(\"GatewayConnectionStore\");\n\t@observable private socket: WebSocket | null = null;\n\t@observable public sessionId: string | null = null;\n\t@observable public session: GatewaySession | undefined;\n\t@observable public readyState: number = WebSocket.CLOSED;\n\n\tprivate app: AppStore;\n\tprivate url?: string;\n\tprivate heartbeatInterval: number | null = null;\n\tprivate heartbeater: NodeJS.Timeout | null = null;\n\tprivate initialHeartbeatTimeout: NodeJS.Timeout | null = null;\n\t// eslint-disable-next-line @typescript-eslint/ban-types\n\tprivate dispatchHandlers: Map<GatewayDispatchEvents, Function> = new Map();\n\tprivate connectionStartTime?: number;\n\tprivate identifyStartTime?: number;\n\tprivate sequence = 0;\n\tprivate heartbeatAck = true;\n\tprivate lazyRequestChannels = new Map<string, Snowflake[]>(); // guild, channels\n\tprivate reconnectTimeout = 0;\n\n\tconstructor(app: AppStore) {\n\t\tthis.app = app;\n\n\t\tmakeObservable(this);\n\t}\n\n\t/**\n\t * Starts connection to gateway\n\t */\n\t@action\n\tasync connect(url: string) {\n\t\tif (!this.url) {\n\t\t\tconst newUrl = new URL(url);\n\t\t\tnewUrl.searchParams.append(\"v\", GATEWAY_VERSION);\n\t\t\tnewUrl.searchParams.append(\"encoding\", GATEWAY_ENCODING);\n\t\t\tthis.url = newUrl.href;\n\t\t}\n\t\tthis.logger.debug(`[Connect] ${this.url}`);\n\t\tthis.connectionStartTime = Date.now();\n\t\tthis.socket = new WebSocket(this.url);\n\t\tthis.readyState = WebSocket.CONNECTING;\n\n\t\tthis.setupListeners();\n\t\tthis.setupDispatchHandler();\n\t}\n\n\t@action\n\tasync disconnect(code?: number, reason?: string) {\n\t\tif (!this.socket) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.readyState = WebSocket.CLOSING;\n\t\tthis.logger.debug(`[Disconnect] ${this.url}`);\n\t\tthis.socket?.close(code, reason);\n\t}\n\n\tstartReconnect() {\n\t\tsetTimeout(() => {\n\t\t\tthis.logger.debug(\"Starting reconnect...\");\n\t\t\tthis.connect(this.url!);\n\t\t}, this.reconnectTimeout);\n\t}\n\n\tprivate setupListeners() {\n\t\tthis.socket!.onopen = this.onopen;\n\t\tthis.socket!.onmessage = this.onmessage;\n\t\tthis.socket!.onerror = this.onerror;\n\t\tthis.socket!.onclose = this.onclose;\n\t}\n\n\tprivate setupDispatchHandler() {\n\t\tthis.dispatchHandlers.set(GatewayDispatchEvents.Ready, this.onReady);\n\t\tthis.dispatchHandlers.set(GatewayDispatchEvents.Resumed, this.onResumed);\n\t\tthis.dispatchHandlers.set(GatewayDispatchEvents.GuildCreate, this.onGuildCreate);\n\t\tthis.dispatchHandlers.set(GatewayDispatchEvents.GuildUpdate, this.onGuildUpdate);\n\t\tthis.dispatchHandlers.set(GatewayDispatchEvents.GuildDelete, this.onGuildDelete);\n\t\tthis.dispatchHandlers.set(GatewayDispatchEvents.GuildMemberAdd, this.onGuildMemberAdd);\n\t\tthis.dispatchHandlers.set(GatewayDispatchEvents.GuildMemberRemove, this.onGuildMemberRemove);\n\t\tthis.dispatchHandlers.set(GatewayDispatchEvents.GuildMemberUpdate, this.onGuildMemberUpdate);\n\t\tthis.dispatchHandlers.set(GatewayDispatchEvents.GuildMemberListUpdate, this.onGuildMemberListUpdate);\n\n\t\tthis.dispatchHandlers.set(GatewayDispatchEvents.ChannelCreate, this.onChannelCreate);\n\t\tthis.dispatchHandlers.set(GatewayDispatchEvents.ChannelUpdate, this.onChannelUpdate);\n\t\tthis.dispatchHandlers.set(GatewayDispatchEvents.ChannelDelete, this.onChannelDelete);\n\n\t\tthis.dispatchHandlers.set(GatewayDispatchEvents.MessageCreate, this.onMessageCreate);\n\t\tthis.dispatchHandlers.set(GatewayDispatchEvents.MessageUpdate, this.onMessageUpdate);\n\t\tthis.dispatchHandlers.set(GatewayDispatchEvents.MessageDelete, this.onMessageDelete);\n\t\tthis.dispatchHandlers.set(GatewayDispatchEvents.MessageDeleteBulk, this.onMessageBulkDelete);\n\n\t\tthis.dispatchHandlers.set(GatewayDispatchEvents.PresenceUpdate, this.onPresenceUpdate);\n\n\t\tthis.dispatchHandlers.set(GatewayDispatchEvents.TypingStart, this.onTypingStart);\n\n\t\tthis.dispatchHandlers.set(GatewayDispatchEvents.UserUpdate, this.onUserUpdate);\n\t}\n\n\tprivate onopen = () => {\n\t\tthis.logger.debug(`[Connected] ${this.url} (took ${Date.now() - this.connectionStartTime!}ms)`);\n\t\tthis.readyState = WebSocket.OPEN;\n\t\tthis.reconnectTimeout = 0;\n\n\t\tthis.handleIdentify();\n\t};\n\n\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\tprivate onmessage = (e: MessageEvent<any>) => {\n\t\tconst payload: GatewayReceivePayload = JSON.parse(e.data);\n\t\tif (payload.op !== GatewayOpcodes.Dispatch) {\n\t\t\tthis.logger.debug(`[Gateway] -> ${payload.op}`, payload);\n\t\t}\n\n\t\tswitch (payload.op) {\n\t\t\tcase GatewayOpcodes.Dispatch:\n\t\t\t\tthis.handleDispatch(payload);\n\t\t\t\tbreak;\n\t\t\tcase GatewayOpcodes.Heartbeat:\n\t\t\t\tthis.sendHeartbeat();\n\t\t\t\tbreak;\n\t\t\tcase GatewayOpcodes.Reconnect:\n\t\t\t\tthis.handleReconnect();\n\t\t\t\tbreak;\n\t\t\tcase GatewayOpcodes.InvalidSession:\n\t\t\t\tthis.handleInvalidSession(payload.d);\n\t\t\t\tbreak;\n\t\t\tcase GatewayOpcodes.Hello:\n\t\t\t\tthis.handleHello(payload.d);\n\t\t\t\tbreak;\n\t\t\tcase GatewayOpcodes.HeartbeatAck:\n\t\t\t\tthis.handleHeartbeatAck();\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tthis.logger.debug(\"Received unknown opcode\");\n\t\t\t\tbreak;\n\t\t}\n\t};\n\n\tprivate onerror = (e: Event) => {\n\t\tthis.logger.error(\"[Gateway] Socket Error\", e);\n\t};\n\n\tprivate onclose = (e: CloseEvent) => {\n\t\tthis.readyState = WebSocket.CLOSED;\n\t\tthis.handleClose(e.code);\n\t};\n\n\tprivate sendJson = (payload: GatewaySendPayload) => {\n\t\tif (!this.socket) {\n\t\t\tthis.logger.error(\"Socket is not open\");\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.socket.readyState !== WebSocket.OPEN) {\n\t\t\tthis.logger.error(`Socket is not open; readyState: ${this.socket.readyState}`);\n\t\t\treturn;\n\t\t}\n\t\tthis.logger.debug(`[Gateway] <- ${payload.op}`, payload);\n\t\tthis.socket.send(JSON.stringify(payload));\n\t};\n\n\t/**\n\t * Sends Identify payload to gateway\n\t */\n\tprivate handleIdentify = () => {\n\t\tthis.logger.debug(\"handleIdentify called\");\n\t\tif (!this.app.token) {\n\t\t\treturn this.logger.error(\"Token shouldn't be null here\");\n\t\t}\n\t\tthis.identifyStartTime = Date.now();\n\n\t\tconst payload: GatewayIdentify = {\n\t\t\top: GatewayOpcodes.Identify,\n\t\t\td: {\n\t\t\t\ttoken: this.app.token!,\n\t\t\t\tcapabilities: 16381,\n\t\t\t\tproperties: {\n\t\t\t\t\tbrowser: \"Spacebar Web\",\n\t\t\t\t\tclient_build_number: 0,\n\t\t\t\t\trelease_channel: \"dev\",\n\t\t\t\t\tbrowser_user_agent: navigator.userAgent,\n\t\t\t\t},\n\t\t\t\tcompress: false,\n\t\t\t\tpresence: {\n\t\t\t\t\tstatus: PresenceUpdateStatus.Online,\n\t\t\t\t\tsince: Date.now(),\n\t\t\t\t\tactivities: [],\n\t\t\t\t\tafk: false,\n\t\t\t\t},\n\t\t\t},\n\t\t};\n\t\tthis.sendJson(payload);\n\t};\n\n\t/**\n\t * Processes an invalid session opcode\n\t */\n\tprivate handleInvalidSession = (resumable: boolean) => {\n\t\tthis.cleanup();\n\n\t\tthis.logger.debug(`Received invalid session; Can Resume: ${resumable}`);\n\t\tif (!resumable) {\n\t\t\treturn;\n\t\t}\n\n\t\t// TODO: handle resumable\n\t};\n\n\t/**\n\t * Processes a reconnect opcode\n\t */\n\tprivate handleReconnect() {\n\t\tthis.cleanup();\n\t\tthis.logger.debug(\"Received reconnect\");\n\n\t\tthis.startReconnect();\n\t}\n\n\tprivate handleResume() {\n\t\tthis.logger.debug(\"handleResume called\");\n\t\tif (!this.app.token) {\n\t\t\treturn this.logger.error(\"Token shouldn't be null here\");\n\t\t}\n\n\t\tthis.sendJson({\n\t\t\top: GatewayOpcodes.Resume,\n\t\t\td: {\n\t\t\t\ttoken: this.app.token!,\n\t\t\t\tsession_id: this.sessionId!,\n\t\t\t\tseq: this.sequence,\n\t\t\t},\n\t\t});\n\t}\n\n\tprivate handleHello = (data: GatewayHelloData) => {\n\t\tthis.heartbeatInterval = data.heartbeat_interval;\n\t\tthis.reconnectTimeout = this.heartbeatInterval;\n\t\tthis.logger.info(\n\t\t\t`[Hello] heartbeat interval: ${data.heartbeat_interval} (took ${Date.now() - this.connectionStartTime!}ms)`,\n\t\t);\n\t\tthis.startHeartbeater();\n\t};\n\n\tcanReconnect(code: GatewayCloseCodes | undefined) {\n\t\tif (!code) {\n\t\t\treturn true;\n\t\t}\n\n\t\tswitch (code) {\n\t\t\tcase GatewayCloseCodes.AuthenticationFailed:\n\t\t\tcase GatewayCloseCodes.InvalidShard:\n\t\t\tcase GatewayCloseCodes.ShardingRequired:\n\t\t\tcase GatewayCloseCodes.InvalidAPIVersion:\n\t\t\tcase GatewayCloseCodes.InvalidIntents:\n\t\t\tcase GatewayCloseCodes.DisallowedIntents:\n\t\t\t\treturn false;\n\t\t\tdefault:\n\t\t\t\treturn true;\n\t\t}\n\t}\n\n\tprivate handleClose = (code: number | undefined) => {\n\t\tthis.cleanup();\n\n\t\tif (code === 4004) {\n\t\t\tthis.logger.warn(\"closed because of authentication failure.\");\n\t\t\t// remove token, this will send us back to the login screen\n\t\t\t// TODO: maybe we could show a toast here so the user knows why they got logged out\n\t\t\tthis.app.logout();\n\t\t\tthis.reset();\n\t\t\tthis.app.setAppLoading(false);\n\t\t\treturn;\n\t\t}\n\n\t\t// dont reconnect on \"going away\"\n\t\tif (code === 1001) return;\n\n\t\tif (this.reconnectTimeout === 0) this.reconnectTimeout = RECONNECT_TIMEOUT;\n\t\telse this.reconnectTimeout += RECONNECT_TIMEOUT;\n\n\t\tthis.logger.debug(\n\t\t\t`Websocket closed with code ${code}; Will reconnect in ${(this.reconnectTimeout / 1000).toFixed(\n\t\t\t\t2,\n\t\t\t)} seconds.`,\n\t\t);\n\n\t\tthis.startReconnect();\n\t};\n\n\t/**\n\t * Resets the gateway state\n\t */\n\tprivate reset = () => {\n\t\tthis.sessionId = null;\n\t\tthis.sequence = 0;\n\t\tthis.readyState = WebSocket.CLOSED;\n\t};\n\n\t/**\n\t * Starts the heartbeat interval\n\t */\n\tprivate startHeartbeater = () => {\n\t\tif (this.heartbeater) {\n\t\t\tclearInterval(this.heartbeater);\n\t\t\tthis.heartbeater = null;\n\t\t}\n\n\t\tconst heartbeaterFn = () => {\n\t\t\tif (this.heartbeatAck) {\n\t\t\t\tthis.heartbeatAck = false;\n\t\t\t\tthis.sendHeartbeat();\n\t\t\t} else {\n\t\t\t\tthis.handleHeartbeatTimeout();\n\t\t\t}\n\t\t};\n\n\t\tthis.initialHeartbeatTimeout = setTimeout(() => {\n\t\t\tthis.initialHeartbeatTimeout = null;\n\t\t\tthis.heartbeater = setInterval(heartbeaterFn, this.heartbeatInterval!);\n\t\t\theartbeaterFn();\n\t\t}, Math.floor(Math.random() * this.heartbeatInterval!));\n\t};\n\n\t/**\n\t * Stops the heartbeat interval\n\t */\n\tprivate stopHeartbeater = () => {\n\t\tif (this.heartbeater) {\n\t\t\tclearInterval(this.heartbeater);\n\t\t\tthis.heartbeater = null;\n\t\t}\n\n\t\tif (this.initialHeartbeatTimeout) {\n\t\t\tclearTimeout(this.initialHeartbeatTimeout);\n\t\t\tthis.initialHeartbeatTimeout = null;\n\t\t}\n\t};\n\n\t/**\n\t * Handles a heartbeat timeout\n\t */\n\tprivate handleHeartbeatTimeout = () => {\n\t\tthis.logger.warn(\n\t\t\t`[Heartbeat ACK Timeout] should reconnect in ${(RECONNECT_TIMEOUT / 1000).toFixed(2)} seconds`,\n\t\t);\n\n\t\tthis.socket?.close(4009);\n\n\t\tthis.cleanup();\n\t\tthis.reset();\n\n\t\tthis.startReconnect();\n\t};\n\n\t/**\n\t * Sends a heartbeat\n\t */\n\tprivate sendHeartbeat = () => {\n\t\tconst payload: GatewayHeartbeat = {\n\t\t\top: GatewayOpcodes.Heartbeat,\n\t\t\td: this.sequence,\n\t\t};\n\t\tthis.logger.debug(\"Sending heartbeat\");\n\t\tthis.sendJson(payload);\n\t};\n\n\t/**\n\t * Stops heartbeat interval and removes socket\n\t */\n\tprivate cleanup = () => {\n\t\tthis.logger.debug(\"Cleaning up\");\n\t\tthis.stopHeartbeater();\n\t\tthis.socket = null;\n\t};\n\n\t/**\n\t * Processes a heartbeat ack opcode\n\t */\n\tprivate handleHeartbeatAck = () => {\n\t\tthis.logger.debug(\"Received heartbeat ack\");\n\t\tthis.heartbeatAck = true;\n\t};\n\n\t/**\n\t * processes a dispatch opcode\n\t */\n\tprivate handleDispatch = (data: GatewayDispatchPayload) => {\n\t\tconst { d, t, s } = data;\n\t\tthis.logger.debug(`[Gateway] -> ${t}`, d);\n\t\tthis.sequence = s;\n\t\tconst handler = this.dispatchHandlers.get(t);\n\t\tif (!handler) {\n\t\t\tthis.logger.debug(`No handler for dispatch event ${t}`);\n\t\t\treturn;\n\t\t}\n\n\t\thandler(d);\n\t};\n\n\t/**\n\t * Processes a resumed dispatch event\n\t */\n\tprivate onResumed = () => {\n\t\tthis.logger.debug(\"Resumed\");\n\t};\n\n\t/**\n\t * Processes a ready dispatch event\n\t */\n\tprivate onReady = (data: GatewayReadyDispatchData) => {\n\t\tthis.logger.info(`[Ready] took ${Date.now() - this.connectionStartTime!}ms`);\n\t\tconst { session_id, guilds, users, user, private_channels, sessions } = data;\n\t\tthis.sessionId = session_id;\n\t\tthis.session = (sessions as GatewaySession[]).find((x) => x.session_id === session_id);\n\n\t\tthis.app.setUser(user);\n\n\t\tthis.app.guilds.addAll(guilds);\n\t\tthis.app.guilds.setInitialGuildsLoaded();\n\t\tif (users) {\n\t\t\tthis.app.users.addAll(users);\n\t\t}\n\t\t// TODO: store relationships\n\t\t// TODO: store readstates\n\t\tthis.app.privateChannels.addAll(private_channels);\n\n\t\tif (data.merged_members) {\n\t\t\t// store merged members (the client users member object for each guild)\n\t\t\tfor (const mm of data.merged_members as (APIGuildMember & { guild_id: string; id: string })[][]) {\n\t\t\t\tfor (const m of mm) {\n\t\t\t\t\tconst guild = this.app.guilds.get(m.guild_id);\n\t\t\t\t\tif (!guild) {\n\t\t\t\t\t\tthis.logger.warn(`[Ready] Guild ${m.guild_id} not found for member ${m.id}`);\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t\tguild.members.add(m);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis.reconnectTimeout = 0;\n\t\tthis.app.setGatewayReady(true);\n\t};\n\n\tpublic onChannelOpen = (guildId: Snowflake, channelId: Snowflake) => {\n\t\tconst guildChannels = this.lazyRequestChannels.get(guildId) ?? [];\n\n\t\tif (guildChannels.includes(channelId)) return;\n\t\tconst payload: GatewayLazyRequestData = {\n\t\t\tguild_id: guildId,\n\t\t\t// activities: true,\n\t\t\t// threads: true,\n\t\t\t// typing: true,\n\t\t\tchannels: {\n\t\t\t\t[channelId]: [[0, 99]],\n\t\t\t},\n\t\t};\n\t\tthis.lazyRequestChannels.set(guildId, [channelId]);\n\n\t\tthis.sendJson({\n\t\t\top: GatewayOpcodes.LazyRequest,\n\t\t\td: payload,\n\t\t} as GatewayLazyRequest);\n\t};\n\n\t// Start dispatch handlers\n\n\tprivate onGuildCreate = (data: GatewayGuildCreateDispatchData) => {\n\t\tthis.logger.debug(\"Received guild create event\");\n\t\trunInAction(() => {\n\t\t\tthis.app.guilds.add({\n\t\t\t\t...data,\n\t\t\t\t...data.properties,\n\t\t\t} as unknown as GatewayGuild);\n\t\t});\n\t};\n\n\tprivate onGuildUpdate = (data: GatewayGuildModifyDispatchData) => {\n\t\tthis.logger.debug(\"Received guild update event\");\n\t\tthis.app.guilds.get(data.id)?.update(data);\n\t};\n\n\tprivate onGuildDelete = (data: GatewayGuildDeleteDispatchData) => {\n\t\tthis.logger.debug(\"Received guild delete event\");\n\t\trunInAction(() => {\n\t\t\tthis.app.guilds.remove(data.id);\n\t\t});\n\t};\n\n\tprivate onGuildMemberAdd = (data: GatewayGuildMemberAddDispatchData) => {\n\t\tthis.logger.debug(\"Received GuildMemberAdd event\");\n\t\tconst guild = this.app.guilds.get(data.guild_id);\n\t\tif (!guild) {\n\t\t\tthis.logger.warn(`[GuildMemberAdd] Guild ${data.guild_id} not found for member ${data.user?.id}`);\n\t\t\treturn;\n\t\t}\n\t\tguild.members.add(data);\n\t};\n\n\tprivate onGuildMemberRemove = (data: GatewayGuildMemberRemoveDispatchData) => {\n\t\tthis.logger.debug(\"Received GuildMemberRemove event\");\n\t\tconst guild = this.app.guilds.get(data.guild_id);\n\t\tif (!guild) {\n\t\t\tthis.logger.warn(`[GuildMemberRemove] Guild ${data.guild_id} not found for member ${data.user.id}`);\n\t\t\treturn;\n\t\t}\n\t\tguild.members.remove(data.user.id);\n\t};\n\n\tprivate onGuildMemberUpdate = (data: GatewayGuildMemberUpdateDispatchData) => {\n\t\tthis.logger.debug(\"Received GuildMemberUpdate event\");\n\t\tconst guild = this.app.guilds.get(data.guild_id);\n\t\tif (!guild) {\n\t\t\tthis.logger.warn(`[GuildMemberUpdate] Guild ${data.guild_id} not found for member ${data.user.id}`);\n\t\t\treturn;\n\t\t}\n\t\tguild.members.update(data as APIGuildMember);\n\t};\n\n\tprivate onGuildMemberListUpdate = (data: GatewayGuildMemberListUpdateDispatchData) => {\n\t\tthis.logger.debug(\"Received GuildMemberListUpdate event\");\n\t\tconst { guild_id } = data;\n\t\tconst guild = this.app.guilds.get(guild_id);\n\n\t\tif (!guild) {\n\t\t\tthis.logger.warn(`[GuildMemberListUpdate] Guild ${guild_id} not found`);\n\t\t\treturn;\n\t\t}\n\n\t\tguild.updateMemberList(data);\n\t};\n\n\tprivate onChannelCreate = (data: GatewayChannelCreateDispatchData) => {\n\t\tif (data.type === ChannelType.DM || data.type === ChannelType.GroupDM) {\n\t\t\tthis.app.privateChannels.add(data);\n\t\t\treturn;\n\t\t}\n\n\t\tconst guild = this.app.guilds.get(data.guild_id!);\n\t\tif (!guild) {\n\t\t\tthis.logger.warn(`[ChannelCreate] Guild ${data.guild_id} not found for channel ${data.id}`);\n\t\t\treturn;\n\t\t}\n\t\tguild.addChannel(data);\n\t};\n\n\tprivate onChannelUpdate = (data: GatewayChannelUpdateDispatchData) => {\n\t\tif (data.type === ChannelType.DM || data.type === ChannelType.GroupDM) {\n\t\t\tthis.app.privateChannels.update(data);\n\t\t\treturn;\n\t\t}\n\n\t\tconst guild = this.app.guilds.get(data.guild_id!);\n\t\tif (!guild) {\n\t\t\tthis.logger.warn(`[ChannelUpdate] Guild ${data.guild_id} not found for channel ${data.id}`);\n\t\t\treturn;\n\t\t}\n\t\tguild.updateChannel(data);\n\t};\n\n\tprivate onChannelDelete = (data: GatewayChannelDeleteDispatchData) => {\n\t\tif (data.type === ChannelType.DM || data.type === ChannelType.GroupDM) {\n\t\t\tthis.app.privateChannels.remove(data.id);\n\t\t\treturn;\n\t\t}\n\n\t\tconst guild = this.app.guilds.get(data.guild_id!);\n\t\tif (!guild) {\n\t\t\tthis.logger.warn(`[ChannelDelete] Guild ${data.guild_id} not found for channel ${data.id}`);\n\t\t\treturn;\n\t\t}\n\t\tguild.removeChannel(data.id);\n\t};\n\n\tprivate onMessageCreate = (data: GatewayMessageCreateDispatchData) => {\n\t\tconst guild = this.app.guilds.get(data.guild_id!);\n\t\tif (!guild) {\n\t\t\tthis.logger.warn(`[MessageCreate] Guild ${data.guild_id} not found for channel ${data.id}`);\n\t\t\treturn;\n\t\t}\n\t\tconst channel = this.app.channels.get(data.channel_id);\n\t\tif (!channel) {\n\t\t\tthis.logger.warn(`[MessageCreate] Channel ${data.channel_id} not found for message ${data.id}`);\n\t\t\treturn;\n\t\t}\n\n\t\tchannel.messages.add(data);\n\t\tthis.app.queue.handleIncomingMessage(data);\n\t};\n\n\tprivate onMessageUpdate = (data: GatewayMessageUpdateDispatchData) => {\n\t\tconst guild = this.app.guilds.get(data.guild_id!);\n\t\tif (!guild) {\n\t\t\tthis.logger.warn(`[MessageUpdate] Guild ${data.guild_id} not found for channel ${data.id}`);\n\t\t\treturn;\n\t\t}\n\t\tconst channel = this.app.channels.get(data.channel_id);\n\t\tif (!channel) {\n\t\t\tthis.logger.warn(`[MessageUpdate] Channel ${data.channel_id} not found for message ${data.id}`);\n\t\t\treturn;\n\t\t}\n\n\t\tchannel.messages.update(data as APIMessage);\n\t};\n\n\tprivate onMessageDelete = (data: GatewayMessageDeleteDispatchData) => {\n\t\tconst guild = this.app.guilds.get(data.guild_id!);\n\t\tif (!guild) {\n\t\t\tthis.logger.warn(`[MessageDelete] Guild ${data.guild_id} not found for channel ${data.id}`);\n\t\t\treturn;\n\t\t}\n\t\tconst channel = this.app.channels.get(data.channel_id);\n\t\tif (!channel) {\n\t\t\tthis.logger.warn(`[MessageDelete] Channel ${data.channel_id} not found for message ${data.id}`);\n\t\t\treturn;\n\t\t}\n\n\t\tchannel.messages.remove(data.id);\n\t};\n\n\tprivate onMessageBulkDelete = (data: GatewayMessageDeleteBulkDispatchData) => {\n\t\tconst guild = this.app.guilds.get(data.guild_id!);\n\t\tif (!guild) {\n\t\t\tthis.logger.warn(`[MessageDeleteBulk] Guild ${data.guild_id} not found.`);\n\t\t\treturn;\n\t\t}\n\t\tconst channel = this.app.channels.get(data.channel_id);\n\t\tif (!channel) {\n\t\t\tthis.logger.warn(`[MessageDeleteBulk] Channel ${data.channel_id} not found.`);\n\t\t\treturn;\n\t\t}\n\n\t\tfor (const id of data.ids) {\n\t\t\tchannel.messages.remove(id);\n\t\t}\n\t};\n\n\tprivate onPresenceUpdate = (data: GatewayPresenceUpdateDispatchData) => {\n\t\tthis.app.presences.update(data);\n\t};\n\n\tprivate onTypingStart = (data: GatewayTypingStartDispatchData) => {\n\t\tconst guild = this.app.guilds.get(data.guild_id!);\n\t\tif (!guild) {\n\t\t\tthis.logger.warn(`[TypingStart] Guild ${data.guild_id} not found for channel ${data.channel_id}`);\n\t\t\treturn;\n\t\t}\n\t\tconst channel = this.app.channels.get(data.channel_id);\n\t\tif (!channel) {\n\t\t\tthis.logger.warn(`[TypingStart] Channel ${data.channel_id} not found`);\n\t\t\treturn;\n\t\t}\n\n\t\tconst stop = debounce(() => {\n\t\t\tthis.logger.debug(`[TypingStart] ${data.user_id} has stopped typing in ${channel.id}`);\n\t\t\trunInAction(() => channel.typingIds.delete(data.user_id));\n\t\t}, 12_000); // little bit of extra delay to allow clients to send continuation typing events\n\n\t\tif (!channel.typingIds.has(data.user_id)) {\n\t\t\trunInAction(() => channel.typingIds.set(data.user_id, stop));\n\t\t\tstop();\n\t\t} else {\n\t\t\tthis.logger.debug(`[TypingStart] ${data.user_id} is still typing in ${channel.id}`);\n\t\t\tchannel.typingIds.get(data.user_id)?.();\n\t\t}\n\t};\n\n\tprivate onUserUpdate = (data: GatewayUserUpdateDispatchData) => {\n\t\tthis.app.users.update(data);\n\t};\n}\n"],"names":["GATEWAY_VERSION","GATEWAY_ENCODING","RECONNECT_TIMEOUT","GatewayConnectionStore","app","__publicField","Logger","payload","GatewayOpcodes","PresenceUpdateStatus","resumable","data","code","heartbeaterFn","_a","d","t","s","handler","session_id","guilds","users","user","private_channels","sessions","x","mm","m","guild","guildId","channelId","runInAction","guild_id","ChannelType","channel","id","stop","debounce","makeObservable","url","newUrl","reason","GatewayDispatchEvents","GatewayCloseCodes","__decorateClass","observable","action"],"mappings":"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"}