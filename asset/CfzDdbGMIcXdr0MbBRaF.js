import{u as M,R as o,a9 as V,aa as W,j as e}from"./DEYDuN7xp-m3cL830AkD.js";import{S as G}from"./CW1_sYa28IzwyibYYiTv.js";import{W as K,A as N,S as $,F as z,d as f,L as j,b as y,a as p,c as S,I as k,e as J,f as O,g as Q,h as X}from"./CW-ATFYSPDbf9_1tZzUl.js";import{T as h}from"./D5IfCODi1RtN0YG4PG7p.js";import{H as Y,a as Z}from"./FMJK5WhG_wwNLtUATHA4.js";import{u as ee}from"./DMCex30FeWvvThtDj-pY.js";import{u as se}from"./zdDLXtJuoQIQMZlDPq5d.js";import{G as b}from"./p92OKrTFGeG4VzMCmQFU.js";import{R as te}from"./hbLYaJX3EGTvbt5QpPV-.js";import{m as ae}from"./BDzl6LkRQpjGU2VD4La_.js";import{M as re}from"./BqR1LSnly-oiYYx2d6T7.js";function xe(){const w=se(),c=ee("LoginPage"),A=M(),[l,C]=o.useState(!1),[v,L]=o.useState(),[R,m]=o.useState(),g=o.useRef(null),[F,T]=o.useState(null),[q,u]=o.useState(!1),{register:x,handleSubmit:P,formState:{errors:t},setError:r,setValue:E,clearErrors:B}=V(),d=()=>{var a;(a=g.current)==null||a.resetCaptcha(),E("captcha_key",void 0)},U=a=>{try{return new URL(a)}catch{return}},I=P(a=>{C(!0),L(void 0),m(void 0),w.rest.post(W.login(),{login:a.login,password:a.password,captcha_key:a.captcha_key,undelete:!1}).then(s=>{if("token"in s&&"settings"in s){w.setToken(s.token,!0);return}else if("ticket"in s){c.info("MFA Required",s),m(s);return}else c.error(s),r("login",{type:"manual",message:"Unknown Error"})}).catch(s=>{var i;if("captcha_key"in s){if(s.captcha_key[0]!=="captcha-required")r("login",{type:"manual",message:`Captcha Error: ${s.captcha_key[0]}`});else if(s.captcha_service!=="hcaptcha")r("login",{type:"manual",message:`Unsupported captcha service: ${s.captcha_service}`});else{L(s.captcha_sitekey),(i=g.current)==null||i.execute();return}d()}else if("message"in s){if(s.errors){const n=ae(s.errors);n?r(n.field,{type:"manual",message:n.error}):r("login",{type:"manual",message:s.message})}else r("login",{type:"manual",message:s.message});d()}else c.error(s),r("login",{type:"manual",message:"Unknown Error"}),d()}).finally(()=>C(!1))}),D=a=>{E("captcha_key",a),I()},H=a=>{B("instance"),u(!1),F&&clearTimeout(F),T(setTimeout(async()=>{const i=U(a.target.value);if(!i)return;u(!0);let n;try{n=await te.getEndpointsFromDomain(i)}catch(_){return u(!1),r("instance",{type:"manual",message:_ instanceof Error&&_.message||"Instance could not be resolved"})}c.debug("Instance lookup has set routes to",n),b.routeSettings=n,b.save(),u(!1)},500))};return v?e.jsx(Y,{captchaRef:g,sitekey:v,onVerify:D}):R?e.jsx(re,{...R,close:()=>{m(void 0),d()}}):e.jsx(K,{children:e.jsxs(N,{children:[e.jsx(Z,{children:e.jsxs(e.Fragment,{children:[e.jsx(G,{height:48,width:"auto"}),e.jsx($,{noBranding:!0,children:"Log into Spacebar"})]})}),e.jsxs(z,{onSubmit:I,children:[e.jsxs(f,{marginBottom:!0,style:{marginTop:0},children:[e.jsxs(j,{error:!!t.instance,children:[e.jsx(y,{children:"Instance"}),q!=!1&&e.jsx(p,{children:e.jsxs(e.Fragment,{children:[e.jsx(h,{children:"-"}),"Checking"]})}),t.instance&&e.jsx(p,{children:e.jsxs(e.Fragment,{children:[e.jsx(h,{children:"-"}),t.instance.message]})})]}),e.jsx(S,{children:e.jsx(k,{type:"url",...x("instance",{required:!0,value:b.routeSettings.wellknown}),placeholder:"Instance Root URL",onChange:H,error:!!t.instance,disabled:l})})]}),e.jsxs(f,{marginBottom:!0,children:[e.jsxs(j,{error:!!t.login,children:[e.jsx(y,{children:"Email"}),t.login&&e.jsx(p,{children:e.jsxs(e.Fragment,{children:[e.jsx(h,{children:"-"}),t.login.message]})})]}),e.jsx(S,{children:e.jsx(k,{type:"email",placeholder:"Email",autoFocus:!0,...x("login",{required:!0}),error:!!t.login,disabled:l})})]}),e.jsxs(f,{marginBottom:!0,children:[e.jsxs(j,{error:!!t.password,children:[e.jsx(y,{children:"Password"}),t.password&&e.jsx(p,{children:e.jsxs(e.Fragment,{children:[e.jsx(h,{children:"-"}),t.password.message]})})]}),e.jsx(S,{children:e.jsx(k,{type:"password",placeholder:"Password",...x("password",{required:!0}),error:!!t.password,disabled:l})})]}),e.jsx(J,{palette:"primary",type:"submit",disabled:l,children:"Login"}),e.jsxs(O,{children:[e.jsx(Q,{children:"New to Spacebar?Â "}),e.jsx(X,{onClick:()=>{A("/register")},type:"button",children:"Register"})]})]})]})})}export{xe as L};
//# sourceMappingURL=CfzDdbGMIcXdr0MbBRaF.js.map
